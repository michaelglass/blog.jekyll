<!doctype html>
<!--[if lt IE 7 ]> <html class="no-js ie6" lang="en"> <![endif]-->
<!--[if IE 7 ]>	   <html class="no-js ie7" lang="en"> <![endif]-->
<!--[if IE 8 ]>	   <html class="no-js ie8" lang="en"> <![endif]-->
<!--[if (gte IE 9)|!(IE)]><!--> <html class="no-js" lang="en"> <!--<![endif]-->
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
		<title>Creating Sitemaps with Comatose CMS | roderick.dk</title>
		
		<meta name="author" content="Morgan Roderick" />

		<!-- Mobile viewport optimized: j.mp/bplateviewport -->
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />

		<!-- CSS: implied media="all" -->
		<link rel="stylesheet" href="/stylesheets/style.css?v=2" />

		<!-- Place favicon.ico & apple-touch-icon.png in the root of your domain and delete these references -->
		<link rel="shortcut icon" href="/favicon.ico" />
		<link rel="apple-touch-icon" href="/apple-touch-icon.png" />
	</head>
	<body>
	  <div id="container">
		<header>
			<a href="/" class="home">roderick.dk</a>
			<ul class="nav">
				<li><a href="/">Blog</a></li>
				<li><a href="/archives.html">Archives</a></li>
				<li><a href="/about/">About</a></li>
				<li><a href="/contact/">Contact</a></li>
			</ul>
			<a href="/atom.xml" class="feed">Subscribe to the feed</a>
		</header>
		<div id="main" role="main">
			<div class="article">
	<article>
		<h1>Creating Sitemaps with Comatose CMS</h1>
		<p>For some time now, I&#8217;ve been using <a href='http://github.com/darthapo/comatose/tree/master'>Comatose CMS</a> for client sites. It is quite possible the smallest Rails based CMS, having only the features you need for most sites and flexible enough to allow you to extend it if you need to.</p>

<p>Whenever you&#8217;re doing content publishing, you should make it as easy as possible for search engines to find and catalog our content. In this post I will show you how you can create a simple <a href='http://www.sitemaps.org'>Sitemap</a> from a Comatose CMS.</p>

<p>Here is how I have created Sitemaps from Comatose. The code samples have been extracted from client projects.</p>

<h2 id='routing'>Routing</h2>

<p>First we will map <code>/sitemap.xml</code> to an action on controller.</p>
<div class='highlight'><pre><code class='ruby'><span class='c1'># routes.rb</span>
<span class='no'>ActionController</span><span class='o'>::</span><span class='no'>Routing</span><span class='o'>::</span><span class='no'>Routes</span><span class='o'>.</span><span class='n'>draw</span> <span class='k'>do</span> <span class='o'>|</span><span class='n'>map</span><span class='o'>|</span>
 	<span class='n'>map</span><span class='o'>.</span><span class='n'>connect</span> <span class='s2'>&quot;sitemap.xml&quot;</span><span class='p'>,</span> <span class='ss'>:controller</span> <span class='o'>=&gt;</span> <span class='s2'>&quot;info&quot;</span><span class='p'>,</span> <span class='ss'>:action</span> <span class='o'>=&gt;</span> <span class='s2'>&quot;sitemap&quot;</span>
<span class='k'>end</span>
</code></pre>
</div>
<h2 id='action'>Action</h2>

<p>In the action of the controller, we will build a collection of pages to include in the sitemap. By not iterating over the <code>children</code> collection of each page, we avoid creating numerous calls to the database. Instead we will just use an SQL based find to create our collection.</p>
<div class='highlight'><pre><code class='ruby'><span class='c1'># info_controller.rb ( or other public controller )</span>
<span class='k'>def</span> <span class='nf'>sitemap</span>
	<span class='n'>respond_to</span> <span class='k'>do</span> <span class='o'>|</span><span class='nb'>format</span><span class='o'>|</span>
   <span class='nb'>format</span><span class='o'>.</span><span class='n'>xml</span> <span class='k'>do</span>
			<span class='vi'>@website_url</span> <span class='o'>=</span> <span class='s1'>&#39;http://www.hamsterboy.dk&#39;</span>
			<span class='vi'>@pages</span> <span class='o'>=</span> <span class='no'>ComatosePage</span><span class='o'>.</span><span class='n'>find</span><span class='p'>(</span><span class='ss'>:all</span><span class='p'>,</span> <span class='ss'>:conditions</span> <span class='o'>=&gt;</span> <span class='s2'>&quot;full_path not like &#39;&#39;&quot;</span><span class='p'>)</span>
			<span class='n'>render</span> <span class='ss'>:action</span> <span class='o'>=&gt;</span> <span class='s1'>&#39;sitemap&#39;</span><span class='p'>,</span> <span class='ss'>:layout</span> <span class='o'>=&gt;</span> <span class='kp'>false</span>
		<span class='k'>end</span>
	<span class='k'>end</span>
<span class='k'>end</span>
</code></pre>
</div>
<h2 id='rendering_sitemap'>Rendering sitemap</h2>

<p>After finding the pages, all we need to do is to render them as a sitemap.</p>

<p>As you will note, the frontpage of the site gets special treatment. It&#8217;s lastmod attribute is set to the current time (as you probably have content from other sources than your Comatose CMS) and more importantly, we&#8217;re setting a <em>different priority</em> from all the other pages. Search engines need to know which content is more important on your site, and Google Webmaster Tools will give you warnings if all your pages have the same priority.</p>
<div class='highlight'><pre><code class='ruby'><span class='c1'># sitemap.rxml</span>
<span class='n'>xml</span><span class='o'>.</span><span class='n'>instruct!</span> 
<span class='n'>xml</span><span class='o'>.</span><span class='n'>urlset</span> <span class='s2'>&quot;xmlns&quot;</span> <span class='o'>=&gt;</span> <span class='s2'>&quot;http://www.sitemaps.org/schemas/sitemap/0.9&quot;</span> <span class='k'>do</span>

	<span class='c1'># create an entry for the frontpage</span>
	<span class='n'>xml</span><span class='o'>.</span><span class='n'>url</span> <span class='k'>do</span>
	  <span class='n'>xml</span><span class='o'>.</span><span class='n'>loc</span>         <span class='s2'>&quot;</span><span class='si'>#{</span><span class='vi'>@website_url</span><span class='si'>}</span><span class='s2'>/&quot;</span>
	  <span class='n'>xml</span><span class='o'>.</span><span class='n'>lastmod</span>     <span class='n'>w3c_date</span><span class='p'>(</span> <span class='no'>Time</span><span class='o'>.</span><span class='n'>now</span> <span class='p'>)</span>
	  <span class='n'>xml</span><span class='o'>.</span><span class='n'>changefreq</span>  <span class='s2'>&quot;weekly&quot;</span>
	  <span class='n'>xml</span><span class='o'>.</span><span class='n'>priority</span>    <span class='mi'>1</span><span class='o'>.</span><span class='mi'>0</span>
	<span class='k'>end</span>

	<span class='c1'># create an entry for each of the pages from the find method</span>
 	<span class='vi'>@pages</span><span class='o'>.</span><span class='n'>each</span> <span class='k'>do</span> <span class='o'>|</span><span class='n'>page</span><span class='o'>|</span>
		<span class='n'>xml</span><span class='o'>.</span><span class='n'>url</span> <span class='k'>do</span>
			<span class='n'>xml</span><span class='o'>.</span><span class='n'>loc</span>         <span class='s2'>&quot;</span><span class='si'>#{</span><span class='vi'>@website_url</span><span class='si'>}</span><span class='s2'>/</span><span class='si'>#{</span><span class='n'>page</span><span class='o'>.</span><span class='n'>full_path</span><span class='si'>}</span><span class='s2'>&quot;</span>
			<span class='n'>xml</span><span class='o'>.</span><span class='n'>lastmod</span>     <span class='n'>w3c_date</span><span class='p'>(</span><span class='n'>page</span><span class='o'>.</span><span class='n'>updated_on</span><span class='p'>)</span>
			<span class='n'>xml</span><span class='o'>.</span><span class='n'>changefreq</span>  <span class='s2'>&quot;weekly&quot;</span>
			<span class='n'>xml</span><span class='o'>.</span><span class='n'>priority</span>    <span class='mi'>0</span><span class='o'>.</span><span class='mi'>9</span>
		<span class='k'>end</span>
	<span class='k'>end</span>
<span class='k'>end</span>
</code></pre>
</div>
<h2 id='formatting_dates_as_w3c_dates'>Formatting dates as W3C dates</h2>

<p>Almost there&#8230; to avoid repetition, I&#8217;ve created a little helper for formatting the dates for sitemaps in the <a href='http://www.w3.org/TR/NOTE-datetime'>W3C Datetime</a> format.</p>
<div class='highlight'><pre><code class='ruby'><span class='k'>module</span> <span class='nn'>SitemapHelper</span>
	<span class='k'>def</span> <span class='nf'>w3c_date</span><span class='p'>(</span><span class='n'>date</span><span class='p'>)</span>
		<span class='n'>date</span><span class='o'>.</span><span class='n'>utc</span><span class='o'>.</span><span class='n'>strftime</span><span class='p'>(</span><span class='s2'>&quot;%Y-%m-%dT%H:%M:%S+00:00&quot;</span><span class='p'>)</span>
	<span class='k'>end</span>
<span class='k'>end</span>
</code></pre>
</div>
<h2 id='final_result'>Final result</h2>

<p>Testing the above code on a virgin Comatose database at <a href='http://localhost:3000/sitemap.xml'>http://localhost:3000/sitemap.xml</a>, you should see something like this</p>
<div class='highlight'><pre><code class='xml'><span class='cp'>&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class='nt'>&lt;urlset</span> <span class='na'>xmlns=</span><span class='s'>&quot;http://www.sitemaps.org/schemas/sitemap/0.9&quot;</span><span class='nt'>&gt;</span>
  <span class='nt'>&lt;url&gt;</span>
    <span class='nt'>&lt;loc&gt;</span>http://example.com/<span class='nt'>&lt;/loc&gt;</span>
    <span class='nt'>&lt;lastmod&gt;</span>2009-03-16T08:41:23+00:00<span class='nt'>&lt;/lastmod&gt;</span>
    <span class='nt'>&lt;changefreq&gt;</span>weekly<span class='nt'>&lt;/changefreq&gt;</span>
    <span class='nt'>&lt;priority&gt;</span>1.0<span class='nt'>&lt;/priority&gt;</span>
  <span class='nt'>&lt;/url&gt;</span>
<span class='nt'>&lt;/urlset&gt;</span>
</code></pre>
</div>
<p>That&#8217;s it, your site is now a little easier for search engines to catalog.</p>

<h2 id='where_do_i_go_from_here'>Where do I go from here?</h2>

<p>Well, that is entirely up to you. If you have any other kind of content that you&#8217;re publishing on your site, it should not be too hard to extend the sitemap to include that as well.</p>

<p>Please do note that this post only describes Sitemap in it&#8217;s simplest form, there are limitations as your sitemaps grows, and there are options to create more specialized sitemaps as well.</p>

<h3 id='resources'>Resources</h3>

<ul>
<li><a href='http://github.com/darthapo/comatose/tree/master'>Comatose CMS</a></li>

<li><a href='http://www.sitemaps.org/'>Sitemap</a></li>

<li><a href='http://www.google.com/webmasters/tools/'>Google Webmaster Tools</a></li>
</ul>
		
		
	</article>
</div>
		</div>
		<footer>
			&copy;Morgan Roderick, unless otherwise noted.
		</footer>
	  </div>

	  <!-- mathiasbynens.be/notes/async-analytics-snippet Change UA-XXXXX-X to be your site's ID -->
	  <script>
		var _gaq=[["_setAccount","UA-869742-1"],["_trackPageview"]];
		(function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];g.async=1;
		g.src=("https:"==location.protocol?"//ssl":"//www")+".google-analytics.com/ga.js";
		s.parentNode.insertBefore(g,s)}(document,"script"));
	  </script>
	</body>
</html>